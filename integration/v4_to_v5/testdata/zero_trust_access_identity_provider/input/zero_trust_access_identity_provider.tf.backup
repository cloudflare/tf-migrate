# Integration test for zero_trust_access_identity_provider v4 to v5 migration

variable "cloudflare_account_id" {
  type = string
}

# Test 1: onetimepin (no config block)
resource "cloudflare_access_identity_provider" "otp" {
  account_id = var.cloudflare_account_id
  name       = "One-Time PIN"
  type       = "onetimepin"
}

# Test 2: GitHub OAuth (basic config)
resource "cloudflare_access_identity_provider" "github" {
  account_id = var.cloudflare_account_id
  name       = "GitHub OAuth"
  type       = "github"

  config {
    client_id     = "github-client-id"
    client_secret = "github-client-secret"
  }
}

# Test 3: Azure AD with SCIM (complex config)
resource "cloudflare_access_identity_provider" "azure" {
  account_id = var.cloudflare_account_id
  name       = "Azure AD SSO"
  type       = "azureAD"

  config {
    client_id                  = "azure-client-id"
    client_secret              = "azure-client-secret"
    directory_id               = "azure-directory-uuid"
    conditional_access_enabled = true
    support_groups             = true
    api_token                  = "deprecated-token"
  }

  scim_config {
    enabled                   = true
    user_deprovision          = true
    seat_deprovision          = false
    group_member_deprovision  = true
    identity_update_behavior  = "automatic"
    secret                    = "user-provided-secret"
  }
}

# Test 4: SAML with idp_public_cert
resource "cloudflare_access_identity_provider" "saml" {
  account_id = var.cloudflare_account_id
  name       = "SAML Provider"
  type       = "saml"

  config {
    issuer_url      = "https://saml.example.com/issuer"
    sso_target_url  = "https://saml.example.com/sso"
    idp_public_cert = "MIIDpDCCAoygAwIBAgIGAV2ka+55MA0GCSqGSIb3DQEBCwUAMIGSMQswCQYDVQQGEwJVUzETMBEG"
    sign_request    = true
  }
}

# Test 5: OIDC with PKCE
resource "cloudflare_access_identity_provider" "oidc" {
  account_id = var.cloudflare_account_id
  name       = "Generic OIDC"
  type       = "oidc"

  config {
    client_id     = "oidc-client-id"
    client_secret = "oidc-client-secret"
    auth_url      = "https://oidc.example.com/authorize"
    token_url     = "https://oidc.example.com/token"
    certs_url     = "https://oidc.example.com/.well-known/jwks.json"
    scopes        = ["openid", "profile", "email"]
    pkce_enabled  = true
  }
}
