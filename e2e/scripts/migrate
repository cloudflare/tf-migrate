#!/usr/bin/env bash

# migrate
# Copies v4/ to migrated-v4_to_v5/ and runs migration on each module

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
E2E_ROOT="$(dirname "$SCRIPT_DIR")"
V4_DIR="${E2E_ROOT}/tf/v4"
GENERATED_DIR="${E2E_ROOT}/migrated-v4_to_v5"
TF_MIGRATE_ROOT="$(dirname "$E2E_ROOT")"
BINARY="${TF_MIGRATE_ROOT}/tf-migrate"

# Check if binary exists
if [[ ! -f "$BINARY" ]]; then
    echo -e "${YELLOW}Binary not found, building...${NC}"
    (cd "$TF_MIGRATE_ROOT" && make build)
fi

# Check if v4 directory exists
if [[ ! -d "$V4_DIR" ]]; then
    echo -e "${RED}Error: v4 directory not found at $V4_DIR${NC}"
    echo -e "${YELLOW}Run ./scripts/init first${NC}"
    exit 1
fi

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}Running v4 to v5 Migration${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Clean and prepare generated directory
echo -e "${YELLOW}Preparing output directory...${NC}"
mkdir -p "${GENERATED_DIR}"

# Clean existing contents but preserve .terraform directory and lock file (installed v5 providers)
if [[ -d "${GENERATED_DIR}" ]]; then
    # Remove all files and directories except .terraform and .terraform.lock.hcl
    find "${GENERATED_DIR}" -mindepth 1 -maxdepth 1 ! -name ".terraform" ! -name ".terraform.lock.hcl" -exec rm -rf {} + 2>/dev/null || true
    if [[ -d "${GENERATED_DIR}/.terraform" ]]; then
        echo -e "${BLUE}  ✓ Preserved v5 provider installation (.terraform/)${NC}"
    fi
    if [[ -f "${GENERATED_DIR}/.terraform.lock.hcl" ]]; then
        echo -e "${BLUE}  ✓ Preserved v5 dependency lock file (.terraform.lock.hcl)${NC}"
    fi
fi

# Copy all files from v4 directory, excluding .terraform, lock file, and backend config
# Include terraform.tfstate for state migration
rsync -a --exclude='.terraform' --exclude='.terraform.lock.hcl' --exclude='backend.hcl' --exclude='backend.configured.hcl' "${V4_DIR}/" "${GENERATED_DIR}/"
echo -e "${GREEN}  ✓ Copied tf/v4/ to migrated-v4_to_v5/ (including state file for migration)${NC}"

# Update provider.tf to use latest version and remove backend config
if [[ -f "${GENERATED_DIR}/provider.tf" ]]; then
    # Update version to 5.0
    sed -i.bak 's/version = "~> 4\.0"/version = "~> 5.0"/' "${GENERATED_DIR}/provider.tf"

    # Remove backend configuration lines (comments + backend block)
    # This removes the 4 lines starting from "# Remote state backend"
    sed -i.bak2 '/# Remote state backend/,/backend "s3" {}/d' "${GENERATED_DIR}/provider.tf"

    echo -e "${GREEN}  ✓ Updated provider.tf to use ~> 5.0 and removed backend config${NC}"
fi
echo ""

# Run migration with recursive flag to process all modules and root files
echo -e "${YELLOW}Migrating all files (including modules and state)...${NC}"
if "$BINARY" --config-dir "$GENERATED_DIR" \
    --state-file "${GENERATED_DIR}/terraform.tfstate" \
    --source-version v4 --target-version v5 \
    migrate --backup=false --recursive; then
    echo -e "${GREEN}  ✓ Migration complete (includes state and cross-module reference updates)${NC}"
else
    echo -e "${RED}  ✗ Migration failed${NC}"
    exit 1
fi

# Clean up any backup files that may have been created
find "${GENERATED_DIR}" -type f \( -name "*.backup" -o -name "*.tfstate.backup" \) -delete 2>/dev/null || true

echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}✓ Migration Complete!${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "${YELLOW}Results:${NC}"
echo -e "  Input (v4):  ${BLUE}${V4_DIR}${NC}"
echo -e "  Output (v5): ${BLUE}${GENERATED_DIR}${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo -e "  cd ${GENERATED_DIR}"
echo -e "  terraform init"
echo -e "  terraform plan"
echo ""
