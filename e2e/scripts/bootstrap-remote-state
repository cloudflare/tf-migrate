#!/usr/bin/env bash

# bootstrap-remote-state
# One-time script to upload existing state to R2 remote backend
# This migrates from local state to remote state

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
E2E_ROOT="$(dirname "$SCRIPT_DIR")"
V4_DIR="${E2E_ROOT}/tf/v4"
TF_MIGRATE_ROOT="$(dirname "$E2E_ROOT")"

# Check required environment variables
if [[ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]]; then
    echo -e "${RED}Error: CLOUDFLARE_ACCOUNT_ID environment variable not set${NC}"
    echo "Please set: export CLOUDFLARE_ACCOUNT_ID=your-account-id"
    exit 1
fi

if [[ -z "${R2_ACCESS_KEY_ID:-}" ]]; then
    echo -e "${RED}Error: R2_ACCESS_KEY_ID environment variable not set${NC}"
    echo "Please set R2 credentials:"
    echo "  export R2_ACCESS_KEY_ID=your-r2-access-key-id"
    echo "  export R2_SECRET_ACCESS_KEY=your-r2-secret-access-key"
    exit 1
fi

if [[ -z "${R2_SECRET_ACCESS_KEY:-}" ]]; then
    echo -e "${RED}Error: R2_SECRET_ACCESS_KEY environment variable not set${NC}"
    exit 1
fi

echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}Bootstrap Remote State${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""

echo -e "${GREEN}Using credentials:${NC}"
echo -e "  ${CYAN}User:       ${CLOUDFLARE_EMAIL:-<not set>}${NC}"
echo -e "  ${CYAN}Account ID: ${CLOUDFLARE_ACCOUNT_ID}${NC}"
echo -e "  ${CYAN}Zone ID:    ${CLOUDFLARE_ZONE_ID:-<not set>}${NC}"
echo -e "  ${CYAN}R2 Key ID:  ${R2_ACCESS_KEY_ID}${NC}"
echo ""

# Check if local state exists
if [[ ! -f "${V4_DIR}/terraform.tfstate" ]]; then
    echo -e "${RED}Error: Local state file not found at ${V4_DIR}/terraform.tfstate${NC}"
    echo "Please run terraform apply first to create initial state."
    exit 1
fi

echo -e "${YELLOW}Current state file:${NC}"
echo -e "  ${V4_DIR}/terraform.tfstate"
echo ""

# Create backend config with account ID
BACKEND_CONFIG="${V4_DIR}/backend.hcl"
BACKEND_CONFIG_TMP="${V4_DIR}/backend.configured.hcl"

echo -e "${YELLOW}Configuring backend with account ID...${NC}"
sed "s/ACCOUNT_ID/${CLOUDFLARE_ACCOUNT_ID}/g" "$BACKEND_CONFIG" > "$BACKEND_CONFIG_TMP"

# Set R2 credentials (Terraform uses AWS S3-compatible API)
export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"

echo -e "${YELLOW}Initializing Terraform with remote backend...${NC}"
cd "$V4_DIR"

# Initialize with backend config and migrate state
terraform init -backend-config="$BACKEND_CONFIG_TMP" -migrate-state

echo ""
echo -e "${GREEN}✓ State successfully migrated to remote backend!${NC}"
echo ""
echo -e "${CYAN}Remote state location:${NC}"
echo -e "  Bucket: tf-migrate-e2e-state"
echo -e "  Key: v4/terraform.tfstate"
echo -e "  Endpoint: https://${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
echo ""
echo -e "${YELLOW}Note:${NC} Local state file should now be deleted (Terraform does this automatically)."
echo -e "The state is now managed remotely in R2."
echo ""

# Clean up temp backend config
rm -f "$BACKEND_CONFIG_TMP"

echo -e "${GREEN}✓ Bootstrap complete!${NC}"
